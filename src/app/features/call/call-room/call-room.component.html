<!-- Notifications -->
<app-notification [show]="showCopyNotification" type="success" title="Успешно"
  message="Ссылка на комнату скопирована в буфер обмена" (closed)="onCopyNotificationClosed()"></app-notification>

<!-- Leave Confirmation Modal -->
<app-modal [isOpen]="showLeaveModal" heading="Покинуть комнату?" (closed)="closeLeaveModal()">
  <p class="text-slate-300 mb-4">Вы уверены, что хотите покинуть эту комнату? Все активные соединения будут завершены.
  </p>

  <div slot="footer">
    <app-button variant="secondary" size="md" (clicked)="closeLeaveModal()">
      Отмена
    </app-button>
    <app-button variant="danger" size="md" (clicked)="leaveRoom()">
      Покинуть
    </app-button>
  </div>
</app-modal>

<!-- Screen Source Picker Modal -->
<app-modal
  [isOpen]="showScreenSourceModal"
  heading="Что показать?"
  size="5xl"
  [scrollable]="true"
  (closed)="closeScreenSourceModal()"
>
  <div class="flex flex-col gap-4">
    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between md:gap-6">
      <p class="text-sm text-white/60">Выберите окно или экран для трансляции</p>
      <app-button
        variant="ghost"
        size="sm"
        [disabled]="screenSourcesLoading"
        (clicked)="refreshScreenSources()"
      >
        <lucide-icon
          [img]="RefreshCcw"
          [size]="16"
          [class.animate-spin]="screenSourcesLoading"
        ></lucide-icon>
        Обновить
      </app-button>
    </div>

    @if (screenSourcesError) {
      <div class="rounded-2xl border border-red-500/30 bg-red-500/10 p-3 text-sm text-red-100">
        Не удалось загрузить список. Попробуйте ещё раз.
      </div>
    }

    @if (screenSourcesLoading) {
      <div class="flex flex-col items-center justify-center gap-3 py-12 text-white/70">
        <lucide-icon [img]="Loader2" [size]="28" class="animate-spin text-white/70"></lucide-icon>
        <p class="text-sm">Ищем окна...</p>
      </div>
    } @else if (!screenSources.length) {
      <div class="flex flex-col items-center justify-center gap-4 py-14 text-center">
        <lucide-icon [img]="MonitorUp" [size]="36" class="text-white/30"></lucide-icon>
        <div class="text-sm text-white/60">
          <p>Ничего не найдено</p>
          <p>Откройте приложение и нажмите «Обновить»</p>
        </div>
      </div>
    } @else {
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-2">
        @for (source of screenSources; track source.id) {
          <button
            type="button"
            (click)="handleScreenSourceSelect(source)"
            class="group flex flex-col gap-3 rounded-2xl border border-white/5 bg-white/5 p-3 text-left transition hover:border-white/15 hover:bg-white/10"
            [class.border-violet-500/40]="pendingScreenSource?.id === source.id"
            [class.bg-violet-500/10]="pendingScreenSource?.id === source.id"
          >
            <div class="relative aspect-video overflow-hidden rounded-xl border border-white/5 bg-black/40">
              @if (source.thumbnail) {
                <img
                  [src]="source.thumbnail"
                  alt="{{ source.name }}"
                  class="h-full w-full object-cover"
                  draggable="false"
                />
              } @else {
                <div class="flex h-full w-full items-center justify-center bg-linear-to-br from-zinc-900 to-zinc-800">
                  <lucide-icon
                    [img]="source.type === 'screen' ? MonitorUp : AppWindow"
                    [size]="48"
                    class="text-white/30"
                  ></lucide-icon>
                </div>
              }
              <div class="absolute left-3 top-3 rounded-full border border-white/10 bg-black/60 px-3 py-1 text-xs font-semibold text-white/80 backdrop-blur">
                {{ source.type === 'screen' ? 'Экран' : 'Окно' }}
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="min-w-0 flex-1">
                <p class="truncate text-base font-semibold text-white/90">{{ source.name }}</p>
                <p class="text-sm text-white/50">
                  @if (source.type === 'screen' && source.displayId) {
                    Дисплей #{{ source.displayId }}
                  } @else if (source.type === 'screen') {
                    Основной дисплей
                  } @else {
                    Приложение
                  }
                </p>
              </div>
              <div class="flex h-10 w-10 items-center justify-center rounded-xl border border-white/10 bg-black/50">
                @if (source.appIcon) {
                  <img [src]="source.appIcon" alt="Иконка приложения" class="h-8 w-8 rounded-lg object-cover" />
                } @else {
                  <lucide-icon
                    [img]="source.type === 'screen' ? MonitorUp : AppWindow"
                    [size]="18"
                    class="text-white/60"
                  ></lucide-icon>
                }
              </div>
            </div>
          </button>
        }
      </div>
    }
  </div>
  <div slot="footer">
    <app-button variant="secondary" size="md" (clicked)="closeScreenSourceModal()">
      Отмена
    </app-button>
  </div>
</app-modal>

<!-- Screen Share Quality Modal -->
<app-modal [isOpen]="showScreenShareModal" heading="Выберите качество демонстрации" (closed)="closeScreenShareModal()">
  <div class="flex flex-col gap-3 p-1">
    @if (isElectronApp && pendingScreenSource; as selectedSource) {
      <div class="flex items-center gap-4 rounded-2xl border border-white/5 bg-white/5 p-3">
        <div class="relative h-16 w-28 overflow-hidden rounded-xl border border-white/5 bg-black/40">
          @if (selectedSource.thumbnail) {
            <img [src]="selectedSource.thumbnail" alt="Предпросмотр источника" class="h-full w-full object-cover" />
          } @else {
            <div class="flex h-full w-full items-center justify-center">
              <lucide-icon
                [img]="selectedSource.type === 'screen' ? MonitorUp : AppWindow"
                [size]="28"
                class="text-white/50"
              ></lucide-icon>
            </div>
          }
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-xs font-semibold uppercase tracking-wide text-white/50">Источник</p>
          <p class="truncate text-base font-semibold text-white">{{ selectedSource.name }}</p>
          <p class="text-sm text-white/50">
            {{ selectedSource.type === 'screen' ? 'Экран' : 'Окно приложения' }}
          </p>
        </div>
        <app-button variant="ghost" size="sm" (clicked)="changeScreenSource()">
          Сменить
        </app-button>
      </div>
    }
    @for (option of screenShareOptions; track option.id) {
    <button type="button" (click)="selectScreenShareQuality(option.id)"
      class="group w-full relative overflow-hidden rounded-2xl border p-4 text-left transition-all duration-200"
      [class.border-violet-500/50]="option.id === selectedScreenShareQuality"
      [class.bg-violet-500/10]="option.id === selectedScreenShareQuality"
      [class.shadow-[0_0_20px_-5px_rgba(139,92,246,0.3)]]="option.id === selectedScreenShareQuality"
      [class.border-white/5]="option.id !== selectedScreenShareQuality"
      [class.bg-white/3]="option.id !== selectedScreenShareQuality"
      [class.hover:border-white/10]="option.id !== selectedScreenShareQuality"
      [class.hover:bg-white/6]="option.id !== selectedScreenShareQuality"
      [class.hover:scale-[1.01]]="true"
      [class.active:scale-[0.99]]="true">
      
      <!-- Selection Glow -->
      @if (option.id === selectedScreenShareQuality) {
        <div class="absolute inset-0 bg-violet-500/5 blur-xl"></div>
      }

      <div class="relative flex items-center gap-4 z-10">
        <!-- Icon Block -->
        <div class="size-12 rounded-xl flex items-center justify-center shrink-0 transition-all duration-200"
             [class.bg-violet-500/20]="option.id === selectedScreenShareQuality" 
             [class.text-violet-400]="option.id === selectedScreenShareQuality"
             [class.bg-white/5]="option.id !== selectedScreenShareQuality" 
             [class.text-white/30]="option.id !== selectedScreenShareQuality"
             [class.group-hover:bg-white/10]="option.id !== selectedScreenShareQuality"
             [class.group-hover:text-white/50]="option.id !== selectedScreenShareQuality">
             <lucide-icon [img]="Monitor" [size]="24"></lucide-icon>
        </div>

        <!-- Info Block -->
        <div class="flex flex-col gap-1.5 flex-1 min-w-0">
          <div class="flex items-center gap-2.5">
            <span class="font-semibold tracking-wide text-[15px] transition-colors"
              [class.text-violet-300]="option.id === selectedScreenShareQuality"
              [class.text-white/90]="option.id !== selectedScreenShareQuality"
              >
              {{ option.label }}
            </span>
            @if (option.id === selectedScreenShareQuality) {
              <lucide-icon [img]="Check" [size]="13" class="text-violet-300"></lucide-icon>
            }
          </div>
          <span class="text-[13px] transition-colors"
            [class.text-violet-200/70]="option.id === selectedScreenShareQuality"
            [class.text-white/50]="option.id !== selectedScreenShareQuality"
            >
            {{ option.description }}
          </span>
        </div>
        
        <!-- Stats Block -->
        <div class="flex flex-col items-end gap-2 shrink-0">
           <div class="flex items-center gap-1.5 text-xs font-bold px-2.5 py-1 rounded-lg border transition-colors w-full justify-end"
                [class.bg-violet-500/10]="option.id === selectedScreenShareQuality"
                [class.border-violet-500/20]="option.id === selectedScreenShareQuality"
                [class.text-violet-200]="option.id === selectedScreenShareQuality"
                [class.bg-black/20]="option.id !== selectedScreenShareQuality"
                [class.border-white/10]="option.id !== selectedScreenShareQuality"
                [class.text-white/60]="option.id !== selectedScreenShareQuality"
              >
            <lucide-icon [img]="Maximize" [size]="12" class="opacity-70"></lucide-icon>
            <span>{{ option.width }}×{{ option.height }}</span>
          </div>
          
          <div class="flex items-center gap-1.5 text-[11px] font-medium px-2 py-1 rounded-full border transition-colors justify-end"
                [class.bg-violet-500/10]="option.id === selectedScreenShareQuality"
                [class.border-violet-500/20]="option.id === selectedScreenShareQuality"
                [class.text-violet-200/80]="option.id === selectedScreenShareQuality"
                [class.bg-black/20]="option.id !== selectedScreenShareQuality"
                [class.border-transparent]="option.id !== selectedScreenShareQuality"
                [class.bg-white/5]="option.id !== selectedScreenShareQuality"
                [class.text-white/50]="option.id !== selectedScreenShareQuality"
                >
            <span>{{ option.frameRate }} FPS</span>
          </div>
        </div>
      </div>
    </button>
    }
  </div>
  <div slot="footer">
    <app-button variant="secondary" size="md" (clicked)="closeScreenShareModal()">
      Отмена
    </app-button>
  </div>
</app-modal>

<!-- Participant Context Menu -->
<app-context-menu [isOpen]="showParticipantContextMenu" [position]="participantContextMenuPosition"
  [items]="participantContextMenuItems" (closed)="closeParticipantContextMenu()"
  (itemClicked)="onParticipantContextMenuItemClick($event)"
  (sliderChanged)="onParticipantVolumeChange($event)"></app-context-menu>

<!-- Loading State -->
@if (isLoading) {
<app-loading-spinner [fullScreen]="true" size="lg" message="Подключение к комнате..."></app-loading-spinner>
}

<!-- Error Banner -->
@if (error) {
<div class="fixed top-6 left-1/2 -translate-x-1/2 z-50 animate-fade-in">
  <div class="bg-red-300/10 backdrop-blur-md border border-red-500/20 rounded-xl py-2.5 px-3.5 shadow-2xl shadow-black/50 flex items-center gap-3">
    <lucide-icon [img]="X" [size]="14" class="text-red-400/90"></lucide-icon>
    <p class="text-[13px] font-medium text-white/90">{{ error }}</p>
  </div>
</div>
}

@if (audioAutoplayBlocked) {
<div class="fixed top-4 left-1/2 -translate-x-1/2 z-40 max-w-lg w-full mx-4">
  <div
    class="bg-amber-900/90 backdrop-blur-xl border border-amber-600/70 rounded-xl p-4 shadow-2xl flex items-start gap-3">
    <lucide-icon [img]="VolumeX" [size]="24" class="text-amber-300 shrink-0"></lucide-icon>
    <div class="text-sm text-white/90">
      <p class="font-semibold">Браузер заблокировал автоматическое воспроизведение звука.</p>
      <p class="text-white/70 mt-1">Кликните по странице или нажмите любую клавишу, чтобы включить звук участников.</p>
    </div>
  </div>
</div>
}

<!-- Microphone Status Banner -->
@if (hasMicrophoneIssue && !isLoading) {
<div class="fixed top-4 left-1/2 -translate-x-1/2 z-40 max-w-lg w-full mx-4">
  <div
    class="bg-violet-900/90 backdrop-blur-xl border border-violet-600/50 rounded-xl p-4 shadow-2xl flex items-start gap-3">
    <lucide-icon [img]="MicOff" [size]="24" class="text-violet-300 shrink-0"></lucide-icon>
    <div class="text-sm text-white/90 flex-1">
      @if (microphRoobertatus === 'denied') {
        <p class="font-semibold">Доступ к микрофону не предоставлен</p>
        <p class="text-white/70 mt-1">Нажмите на кнопку микрофона, чтобы попробовать снова, или разрешите доступ в настройках браузера.</p>
      } @else if (microphRoobertatus === 'not-found') {
        <p class="font-semibold">Микрофон не найден</p>
        <p class="text-white/70 mt-1">Подключите микрофон и нажмите на кнопку микрофона для повторной попытки.</p>
      }
    </div>
    <button 
      (click)="requestMicrophoneAccess()" 
      class="shrink-0 px-3 py-1.5 rounded-lg bg-violet-500/30 hover:bg-violet-500/50 text-violet-200 text-xs font-medium transition-colors">
      Повторить
    </button>
  </div>
</div>
}

<!-- Main Call Room -->
@if (!isLoading) {
<div class="h-screen w-full bg-[#0A0A0C] p-[10px] gap-[6px] grid grid-cols-[292px_1fr_292px]">

  <!-- Sidebar с участниками -->
  <aside class="rounded-[28px] backdrop-blur-3xl bg-[#0D0D10] flex flex-col relative z-2">
    <div class="p-[16px] pt-[18px] flex flex-col">
      <div class="flex items-center justify-between mb-[20px]">
        <app-logo wrapperClass="ml-[5px]"></app-logo>
        <div class="flex items-center gap-[6px]">
          <button (click)="confirmLeaveRoom()"
          class="size-[35px] rounded-[11px] bg-white/3 flex items-center justify-center transition-colors hover:bg-white/5 text-white/40 hover:text-white/90"
          [appTooltip]="'Покинуть комнату'" tooltipPosition="bottom">
          <lucide-icon [img]="LogOut" [size]="16" style="transform: scaleX(-1);"></lucide-icon>
        </button>
        <button (click)="copyRoomLink()"
        class="size-[35px] rounded-[11px] bg-white/3 flex items-center justify-center transition-colors hover:bg-white/5 text-white/40 hover:text-white/90"
        [appTooltip]="'Скопировать ссылку на комнату'" tooltipPosition="bottom">
          <lucide-icon [img]="Link" [size]="16"></lucide-icon>
        </button>
        </div>
      </div>


      <div class="flex flex-col relative">
        <div class="flex items-center gap-[6px] mb-[10px] ml-[5px]">
          <h2 class="text-sm text-white/50 font-medium">Участники комнаты</h2>
          <span class="text-sm text-white/25 font-medium">{{ participants.length }}</span>
        </div>
        <div class="flex flex-col gap-[10px] items-start w-full">
          @for (participant of participants; track participant.id) {
          <div
            class="flex items-center justify-between rounded-[15px] px-[10px] py-[9px] transition-colors bg-white/3 hover:bg-white/5 cursor-pointer w-full max-w-full"
            (contextmenu)="openParticipantContextMenu($event, participant)">
            <div class="flex items-center gap-[10px] w-full">
              <app-avatar [src]="resolveAvatarUrl(participant.avatarUrl)" [name]="participant.username || ''"
                [alt]="participant.username || ''" sizeClass="size-[32px]" fontSizeClass="text-lg" [showDecoration]="true"
                [decorationSrc]="resolveDecorationUrl(participant.decorationUrl)"></app-avatar>
            <div class="flex flex-col gap-px items-start flex-1 min-w-0 max-w-full overflow-hidden relative">
              <div class="flex items-center gap-[10px] w-full">
                <p class="text-[15px] font-semibold text-white/90 text-ellipsis overflow-hidden whitespace-nowrap">{{ participant.displayName }}</p>
                <div class="flex items-center gap-[2px] shrink-0">
                  @if (!isParticipantMuted(participant)) {
                  } @else {
                    <svg class="size-[12px] text-slate-200/50" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <defs>
                        <mask [id]="'micMuteMask-' + participant.id">
                          <rect width="100%" height="100%" fill="white"/>
                          <line x1="18" y1="0" x2="2" y2="16" stroke="black" stroke-width="6" stroke-linecap="round"/>
                        </mask>
                      </defs>
                      <g [attr.mask]="'url(#micMuteMask-' + participant.id + ')'">
                        <path d="M10,12c-2.2,0-4-1.8-4-4V4c0-2.2,1.8-4,4-4h0c2.2,0,4,1.8,4,4v4C14,10.2,12.2,12,10,12z"/>
                        <path d="M17.4,10.1c-0.5-0.3-1.1-0.1-1.4,0.4C14.8,12.7,12.5,14,10,14c-2.5,0-4.8-1.3-6.1-3.5C3.7,10,3,9.9,2.6,10.1c-0.5,0.3-0.6,0.9-0.4,1.4c1.4,2.5,4,4.1,6.8,4.4V18H6c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1s-0.4-1-1-1h-3v-2.1c2.8-0.3,5.4-1.9,6.8-4.4C18.1,11,17.9,10.4,17.4,10.1z"/>
                      </g>
                      <line x1="18" y1="0" x2="2" y2="16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  }
                </div>
              </div>
              <p class="text-[13px] font-normal text-white/36 text-ellipsis overflow-hidden whitespace-nowrap w-full">
                @if (isParticipantScreenSharing(participant)) {
                Демонстрирует экран
                } @else {
                Участник
                }
              </p>
            </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    

    <div class="absolute bottom-[8px] left-0 right-0 px-[8px] w-full">
      <div class="relative w-full rounded-[26px] bg-white/3 flex flex-col p-[17px] gap-[26px]">
      <div class="flex flex-col gap-[7px]">
        <div class="flex items-center justify-between text-(--text-positive-light)">
          <p class="text-current text-[15px] font-medium">Мы установили соединение</p>
          <span class="flex items-center text-current">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g clip-path="url(#clip0_32_32)">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M0 12.0212V14H1.99289C1.99289 12.9068 1.10107 12.0212 0 12.0212ZM0 7.91455V9.89331C1.99288 9.89331 4.03558 11.8719 4.03558 13.8506H6.02847C6.02847 10.8826 2.98932 7.91455 0 7.91455ZM0 0V1.97876C6.97509 1.97876 12.0071 6.92529 12.0071 13.8506H14C14 5.93596 7.97153 0 0 0ZM10.0142 13.8506H8.02136C8.02136 8.90394 3.98576 5.93604 0 5.93604V3.95728C5.97865 3.95728 10.0142 7.91462 10.0142 13.8506Z" fill="currentColor"/>
              </g>
              <defs>
              <clipPath id="clip0_32_32">
              <rect width="14" height="14" fill="white"/>
              </clipPath>
              </defs>
              </svg>              
          </span>
        </div>
      </div>

      <div class="flex flex-col gap-[18px] w-full">
        <div class="flex items-center gap-[25px] justify-between w-full max-w-full">
          <div class="flex items-center gap-[12px] max-w-full min-w-0">
            <app-avatar [src]="resolveAvatarUrl(currentUser?.avatarUrl)" [name]="currentUser?.username || ''"
              [alt]="currentUser?.username || ''" sizeClass="size-[35px]" fontSizeClass="text-lg"
              [showDecoration]="true" [decorationSrc]="resolveDecorationUrl(currentUser?.decorationUrl)"></app-avatar>
              <span class="font-semibold text-white/90 truncate text-[16px] block max-w-full">{{ currentUser?.displayName ||
                currentUser?.username }}</span>
          </div>
          <div class="flex items-center shrink-0">
            <button (click)="openSettingsModal()"
              class="group size-[36px] flex items-center justify-center rounded-[11px] hover:bg-white/5 text-white/50 hover:text-white/90 transition-colors">
              <svg class="h-[17px] w-auto will-change-transform transition-transform duration-500 ease-in-out group-hover:transform-[rotate(90deg)]" width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.1806 0.137417C9.84635 4.03508e-08 9.42257 0 8.575 0C7.72743 0 7.30364 4.03508e-08 6.9694 0.137417C6.52368 0.320642 6.16957 0.672082 5.98495 1.11442C5.90067 1.31634 5.86769 1.55117 5.85478 1.89371C5.83582 2.3971 5.5757 2.86305 5.13613 3.11492C4.69655 3.36678 4.1599 3.35737 3.71116 3.12199C3.40579 2.9618 3.18438 2.87273 2.96604 2.84421C2.48773 2.78171 2.004 2.91035 1.62127 3.20181C1.33421 3.42041 1.12232 3.78464 0.698545 4.51309C0.274768 5.24155 0.0628843 5.60578 0.0156586 5.9618C-0.047318 6.43649 0.0822998 6.91656 0.375989 7.29642C0.510039 7.46982 0.698427 7.6155 0.990817 7.79783C1.42066 8.06592 1.69723 8.52256 1.69721 9.02632C1.69718 9.53007 1.42061 9.98663 0.990817 10.2546C0.698382 10.437 0.509958 10.5828 0.375899 10.7562C0.0822097 11.136 -0.0473992 11.6161 0.0155684 12.0908C0.0627941 12.4467 0.274687 12.8111 0.698454 13.5395C1.12223 14.2679 1.33412 14.6322 1.62118 14.8507C2.00391 15.1422 2.48764 15.2708 2.96595 15.2083C3.18428 15.1798 3.40567 15.0907 3.71101 14.9306C4.15979 14.6952 4.69648 14.6858 5.13608 14.9376C5.57568 15.1896 5.83581 15.6555 5.85478 16.159C5.86769 16.5015 5.90067 16.7363 5.98495 16.9382C6.16957 17.3805 6.52368 17.732 6.9694 17.9153C7.30364 18.0526 7.72743 18.0526 8.575 18.0526C9.42257 18.0526 9.84635 18.0526 10.1806 17.9153C10.6263 17.732 10.9804 17.3805 11.165 16.9382C11.2493 16.7363 11.2824 16.5015 11.2953 16.1589C11.3142 15.6555 11.5743 15.1896 12.0138 14.9376C12.4534 14.6857 12.9901 14.6952 13.4389 14.9306C13.7443 15.0907 13.9656 15.1797 14.184 15.2083C14.6623 15.2708 15.146 15.1422 15.5287 14.8507C15.8158 14.6321 16.0277 14.2679 16.4515 13.5394C16.8752 12.811 17.0871 12.4467 17.1344 12.0908C17.1973 11.6161 17.0677 11.1359 16.7741 10.7561C16.6399 10.5827 16.4515 10.4369 16.1591 10.2546C15.7293 9.98663 15.4528 9.52998 15.4528 9.02623C15.4528 8.52247 15.7293 8.06601 16.1591 7.79802C16.4516 7.61559 16.64 7.46991 16.7741 7.29642C17.0678 6.91662 17.1974 6.43655 17.1345 5.96185C17.0872 5.60584 16.8753 5.24161 16.4515 4.51316C16.0278 3.78471 15.8159 3.42048 15.5288 3.20188C15.1461 2.91041 14.6623 2.78178 14.184 2.84427C13.9657 2.8728 13.7443 2.96186 13.439 3.12202C12.9902 3.35742 12.4535 3.36683 12.0139 3.11495C11.5744 2.86307 11.3142 2.39708 11.2952 1.89367C11.2823 1.55115 11.2493 1.31633 11.165 1.11442C10.9804 0.672082 10.6263 0.320642 10.1806 0.137417ZM8.575 11.7342C10.0819 11.7342 11.3035 10.5219 11.3035 9.02632C11.3035 7.53075 10.0819 6.31842 8.575 6.31842C7.06805 6.31842 5.84649 7.53075 5.84649 9.02632C5.84649 10.5219 7.06805 11.7342 8.575 11.7342Z" fill="currentColor" />
              </svg>                
            </button>
          </div>
        </div>

        @if (pushToTalkEnabled) {
        <div class="flex flex-wrap items-center justify-between gap-3 rounded-[20px] border border-emerald-400/30 bg-emerald-500/5 px-4 py-2">
          <div class="flex items-center gap-2 text-emerald-200">
            <lucide-icon [img]="Mic" [size]="16"></lucide-icon>
            <span class="text-sm font-semibold text-white">Режим рации</span>
          </div>
          <div class="flex flex-wrap items-center gap-2 text-xs text-white/60">
            <span class="uppercase tracking-wide text-white/40">Комбинация</span>
            <span class="text-sm font-semibold text-white">{{ pushToTalkShortcutLabel }}</span>
            <span class="px-2 py-1 rounded-full bg-white/10 border border-white/10 text-[11px] text-white/70">
              {{ pushToTalkStatusLabel }}
            </span>
            @if (pushToTalkManualOverride) {
            <span class="text-[11px] text-white/70">Закреплено кнопкой микрофона</span>
            } @else {
            <span class="text-[11px] text-white/50">Удерживайте комбинацию, чтобы говорить</span>
            }
          </div>
        </div>
        }

        <div class="flex items-center gap-[4px]">
          <button
          (click)="toggleMute()" [appTooltip]="getMicrophoneTooltip()" tooltipPosition="top" [attr.aria-label]="getMicrophoneTooltip()" class="size-[38px] flex items-center justify-center rounded-[11px] hover:bg-white/5 text-white/50 hover:text-white/90 transition-colors">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9.00002 10.8C7.02002 10.8 5.40002 9.18 5.40002 7.2V3.6C5.40002 1.62 7.02002 0 9.00002 0C10.98 0 12.6 1.62 12.6 3.6V7.2C12.6 9.18 10.98 10.8 9.00002 10.8Z" fill="currentColor"/>
              <path d="M15.66 9.08999C15.21 8.81999 14.67 8.99999 14.4 9.44999C13.32 11.43 11.25 12.6 8.99998 12.6C6.74998 12.6 4.67998 11.43 3.50998 9.44999C3.32998 8.99999 2.69998 8.90999 2.33998 9.08999C1.88998 9.35999 1.79998 9.89999 1.97998 10.35C3.23998 12.6 5.57998 14.04 8.09998 14.31V16.2H5.39998C4.85998 16.2 4.49998 16.56 4.49998 17.1C4.49998 17.64 4.85998 18 5.39998 18H12.6C13.14 18 13.5 17.64 13.5 17.1C13.5 16.56 13.14 16.2 12.6 16.2H9.89998V14.31C12.42 14.04 14.76 12.6 16.02 10.35C16.29 9.89999 16.11 9.35999 15.66 9.08999Z" fill="currentColor"/>
              </svg>
          </button>
          <button (click)="toggleDeafen()" [appTooltip]="isDeafened ? 'Включить звук' : 'Выключить звук'" tooltipPosition="top" [attr.aria-label]="isDeafened ? 'Включить звук' : 'Выключить звук'" class="size-[38px] flex items-center justify-center rounded-[11px] hover:bg-white/5 text-white/50 hover:text-white/90 transition-colors">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g clip-path="url(#clip0_32_91)">
              <path d="M17.5113 12.0698L17.7694 12.2358C17.8684 12.2996 17.9044 12.4273 17.8529 12.5334L15.5116 17.3642C15.4717 17.4465 15.389 17.4955 15.3019 17.4955C15.2768 17.4955 15.2513 17.4914 15.2264 17.4828L13.7666 16.9815L13.3884 17.7619C13.3593 17.8219 13.3059 17.8664 13.2418 17.8845C13.2212 17.8904 13.1999 17.8932 13.1789 17.8932C13.1346 17.8932 13.0908 17.8805 13.0528 17.8562L10.3125 16.0931C10.2135 16.0292 10.1775 15.9016 10.229 15.7956L13.3487 9.35882C13.4001 9.25288 13.5224 9.2021 13.6339 9.24021L16.3629 10.1774C16.5914 8.55259 16.2894 6.85608 15.469 5.42204C14.3755 3.51057 12.4334 2.14828 10.2738 1.77791C8.05327 1.39701 5.72737 2.06293 4.05163 3.55967C2.37068 5.06099 1.44621 7.30219 1.5787 9.55486C1.59091 9.76311 1.61392 9.97144 1.64411 10.179L4.37774 9.24031C4.48946 9.2022 4.6117 9.25307 4.66304 9.35892L7.78269 15.7957C7.83412 15.9018 7.79825 16.0294 7.69911 16.0932L4.95887 17.8563C4.92094 17.8807 4.87715 17.8933 4.8328 17.8933C4.81165 17.8933 4.7905 17.8905 4.76982 17.8846C4.70571 17.8665 4.65232 17.8219 4.62325 17.762L4.24506 16.9816L2.7853 17.4829C2.76033 17.4915 2.7348 17.4956 2.70965 17.4956C2.62253 17.4956 2.53988 17.4466 2.50001 17.3643L0.158823 12.5334C0.107391 12.4273 0.143356 12.2997 0.2424 12.2359L0.499467 12.0706C0.227958 11.2917 0.0641583 10.4805 0.0151488 9.64673C-0.14511 6.92083 0.973816 4.20863 3.00836 2.39146C5.03676 0.579598 7.85183 -0.227009 10.5387 0.234109C13.1541 0.682648 15.5055 2.33136 16.8286 4.64422C18.108 6.88049 18.3454 9.64375 17.5113 12.0698Z" fill="currentColor"/>
              </g>
              <defs>
              <clipPath id="clip0_32_91">
              <rect width="18" height="18" fill="white"/>
              </clipPath>
              </defs>
              </svg>
          </button>
          <button (click)="handleScreenShareClick()" [appTooltip]="isScreenSharing ? 'Остановить демонстрацию экрана' : 'Начать демонстрацию экрана'" tooltipPosition="top" [attr.aria-label]="isScreenSharing ? 'Остановить демонстрацию экрана' : 'Начать демонстрацию экрана'" class="size-[38px] flex items-center justify-center rounded-[11px] hover:bg-white/5 text-white/50 hover:text-white/90 transition-colors">
            <svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path opacity="0.4" d="M18.3109 4.29293V10.1488H0.319946V4.29293C0.319946 2.10373 2.10373 0.319946 4.29292 0.319946H14.338C16.5272 0.319946 18.3109 2.10373 18.3109 4.29293Z" fill="currentColor" stroke="currentColor" stroke-width="0.64"/>
              <path d="M0.319946 10.1577V10.3379C0.319946 12.5361 2.10373 14.3109 4.29292 14.3109H7.75238C8.24787 14.3109 8.65328 14.7163 8.65328 15.2118V16.0857C8.65328 16.5812 8.24787 16.9866 7.75238 16.9866H5.5722C5.20283 16.9866 4.89652 17.2929 4.89652 17.6622C4.89652 18.0316 5.19382 18.3379 5.5722 18.3379H13.0947C13.4641 18.3379 13.7704 18.0316 13.7704 17.6622C13.7704 17.2929 13.4641 16.9866 13.0947 16.9866H10.9145C10.419 16.9866 10.0136 16.5812 10.0136 16.0857V15.2118C10.0136 14.7163 10.419 14.3109 10.9145 14.3109H14.347C16.5452 14.3109 18.3199 12.5271 18.3199 10.3379V10.1577H0.319946Z" fill="currentColor" stroke="currentColor" stroke-width="0.64"/>
              </svg>
          </button>
          <button appTooltip="Звуковые эффекты" tooltipPosition="top" aria-label="Звуковые эффекты" class="size-[38px] flex items-center justify-center rounded-[11px] hover:bg-white/5 text-white/50 hover:text-white/90 transition-colors">
            <svg width="17" height="21" viewBox="0 0 17 21" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M8.78785 15.3802V12.4954H4.40531C2.71122 12.4954 1.27491 13.741 1.03533 15.4181C0.717886 17.6402 2.60025 19.5559 4.82755 19.2774L5.41186 19.2044C7.34046 18.9634 8.78785 17.3238 8.78785 15.3802Z" fill="currentColor"/>
              <path d="M8.78785 6.20821V5.56747C8.78785 3.87169 8.78785 3.02381 9.28443 2.43755C9.78111 1.85129 10.6174 1.71189 12.2902 1.43311L14.7596 1.02153C14.9019 0.997817 14.9731 0.985955 15.0114 1.02754C15.0499 1.06912 15.0324 1.13912 14.9974 1.27908L14.0592 5.03171C14.0435 5.09424 14.0358 5.1255 14.0138 5.14646C13.9918 5.16742 13.9602 5.17374 13.8969 5.18638L8.78785 6.20821ZM8.78785 6.20821V12.4953M8.78785 12.4953V15.3801C8.78785 17.3238 7.34046 18.9633 5.41187 19.2043L4.82755 19.2774C2.60025 19.5558 0.717886 17.6401 1.03533 15.4181C1.27491 13.741 2.71122 12.4953 4.40531 12.4953H8.78785Z" stroke="currentColor" stroke-width="2"/>
              </svg>
          </button>
        </div>
      </div>
      </div>
    </div>
  </aside>

  <main class="bg-[#0D0D10] backdrop-blur-sm rounded-[28px] flex flex-col overflow-hidden relative z-2">
    <!-- Header with Room Info -->
    <div class="flex items-center gap-[16px] shrink-0 px-[30px] pt-[22px]">
      <h2 class="text-[24px] font-semibold text-white/40">Чат</h2>
    </div>

    <div class="relative w-full flex flex-col flex-1 min-h-0 mt-4">
      <div class="flex-1 relative flex flex-col overflow-hidden transition-colors">
        <!-- Chat Messages Area -->
        <div #chatContainer
          class="flex-1 overflow-y-auto px-[23px] pb-[23px] space-y-3 scrollbar-thin scrollbar-thumb-white/10 scrollbar-track-transparent hover:scrollbar-thumb-white/20">
          @for (item of chatGroups; track $index) {
            @if (isDateSeparator(item)) {
              <div class="flex items-center gap-4 py-4 select-none">
                <div class="h-px bg-white/10 flex-1"></div>
                <span class="text-xs font-medium text-white/40">{{ item.label }}</span>
                <div class="h-px bg-white/10 flex-1"></div>
              </div>
            } @else if (isMessageGroup(item)) {
              <div class="flex flex-col">
                @for (msg of item.messages; track msg.id; let first = $first) {
                  <div class="relative group/msg hover:bg-white/5 transition-colors duration-100 flex items-center -mx-[23px] px-[23px] py-[2px]">
                    @if (first) {
                      <div class="absolute left-[23px] top-[2px] mt-1 size-10 select-none">
                        <app-avatar [src]="resolveAvatarUrl(item.user.avatarUrl)" [name]="item.user.username"
                          [alt]="item.user.username" sizeClass="size-10" fontSizeClass="text-lg" [showDecoration]="true"
                          [decorationSrc]="resolveDecorationUrl(item.user.decorationUrl)"></app-avatar>
                      </div>
                    }
        
                    <div class="pl-[52px]">
                      @if (first) {
                        <div class="flex items-baseline gap-2 mb-1">
                          <span
                            class="font-semibold text-white/90 text-[15px] hover:underline cursor-pointer transition-colors">{{
                            item.user.displayName || item.user.username }}</span>
                          <span class="text-[11px] text-white/30 font-normal">{{ formatMessageTime(item.createdAt) }}</span>
                        </div>
                      }
                      
                      <div class="relative">
                        <p class="text-white/90 text-[15px] leading-relaxed wrap-break-anywhere whitespace-pre-wrap font-light tracking-wide" [innerHTML]="msg.content | linkify"></p>
                        
                        @if (msg.files?.length) {
                        <div class="flex flex-col gap-2 mt-2">
                          @if (getMediaFiles(msg.files); as mediaFiles) {
                            @if (mediaFiles.length > 0) {
                              <div class="grid gap-1.5 rounded-2xl overflow-hidden mt-1.5 w-fit select-none" [ngClass]="getMediaGridClass(mediaFiles.length)">
                                @for (file of mediaFiles; track $index) {
                                  <div 
                                    class="relative group/media cursor-pointer overflow-hidden bg-black/20 transition-all hover:brightness-110" 
                                    [ngClass]="getMediaItemClass($index, mediaFiles.length, file)"
                                    (click)="openMediaViewer(file.url, file.type, msg.user.displayName || msg.user.username || '', msg.createdAt, file.name)"
                                  >
                                    @if (isImage(file.type)) {
                                      <img [src]="getDownloadUrl(file.url) + '?inline=true'" class="w-full h-full object-cover" loading="lazy">
                                    } @else {
                                      <video [src]="getDownloadUrl(file.url) + '?inline=true'" class="w-full h-full object-cover"></video>
                                      <div class="absolute inset-0 flex items-center justify-center bg-black/20 group-hover/media:bg-black/10 transition-colors duration-300 ease-out">
                                          <div class="p-3 pl-4 rounded-full bg-white/20 text-white backdrop-blur-md group-hover/media:bg-white/10 transition-colors duration-300 ease-out shadow-lg">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                          </div>
                                       </div>
                                    }
                                  </div>
                                }
                              </div>
                            }
                          }
          
                          @if (hasOtherFiles(msg.files)) {
                          <div class="flex flex-wrap gap-2 w-full">
                            @for (file of msg.files; track $index) {
                              @if (!isImage(file.type) && !isVideo(file.type)) {
                              <a title="Нажмите, чтобы скачать файл" aria-label="Нажмите, чтобы скачать файл" role="button" [href]="getDownloadUrl(file.url)" download target="_blank" class="group/file relative flex flex-col items-center gap-2 p-3 rounded-xl bg-white/3 transition-all overflow-hidden min-w-[120px] select-none pointer-events-none">
                                
                                <div class="size-14 bg-violet-500/10 rounded-xl flex items-center justify-center relative">
                                  <lucide-icon [img]="File" [size]="32" class="text-violet-400"></lucide-icon>
                                  <span class="absolute text-[10px] font-black text-white bg-violet-600/90 px-1.5 py-0.5 rounded-md shadow-lg translate-y-1 uppercase tracking-wider border border-white/10">
                                    {{ getFileExtension(file.name) }}
                                  </span>
                                </div>
              
                                <div class="text-center w-full px-1">
                                  <p class="text-xs font-medium text-white/90 truncate max-w-[140px]" [title]="file.name">{{ file.name }}</p>
                                  <p class="text-[10px] text-white/40 mt-0.5 font-medium">{{ formatFileSize(file.size) }}</p>
                                </div>
              
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover/file:opacity-100 flex items-center justify-center transition-all pointer-events-auto">
                                  <div class="size-10 rounded-full bg-white/10 flex items-center justify-center border border-white/5 shadow-xl translate-y-2 group-hover/file:translate-y-0 transition-all group-active/file:scale-95 text-white/90 cursor-pointer">
                                    <lucide-icon [img]="Download" [size]="20"></lucide-icon>
                                  </div>
                                </div>
                              </a>
                              }
                            }
                          </div>
                          }
                        </div>
                        }

                        @if (msg.linkPreview) {
                          <div class="mt-1 mb-1 w-full">
                            <app-link-preview [preview]="msg.linkPreview" (mediaClick)="openLinkPreviewMedia(msg)"></app-link-preview>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          } @empty {
          <div class="h-full flex flex-col items-center justify-center text-white/20 select-none pb-12">
            <div class="size-16 rounded-2xl bg-white/5 flex items-center justify-center mb-4">
              <lucide-icon [img]="MessageSquare" [size]="32" class="opacity-50"></lucide-icon>
            </div>
            <p class="text-sm font-medium text-white/40">Чат пуст</p>
            <p class="text-xs text-white/20 mt-1">Начните общение первым</p>
          </div>
          }
        </div>

        <!-- Chat Input Area -->
        <input type="file" #fileInput class="hidden" multiple (change)="onFileSelected($event)">
        
        <div class="p-[14px] px-[20px] border-t border-white/5 mt-auto flex flex-col gap-2">
          @if (selectedFiles.length) {
          <div class="flex flex-wrap gap-2 max-h-[150px] overflow-y-auto custom-scrollbar">
            @for (fileEntry of selectedFiles; track $index) {
            <div class="flex items-center gap-3 bg-white/5 rounded-xl p-2.5 border border-white/5 animate-fade-in w-fit max-w-full relative group">
              @if (fileEntry.previewUrl) {
                <div class="size-10 rounded-lg overflow-hidden shrink-0 bg-black/20 relative">
                  @if (isImage(fileEntry.file.type)) {
                     <img [src]="fileEntry.previewUrl" class="w-full h-full object-cover">
                  } @else {
                     <video [src]="fileEntry.previewUrl" class="w-full h-full object-cover"></video>
                  }
                </div>
              } @else {
                <div class="size-10 bg-violet-500/10 rounded-lg flex items-center justify-center shrink-0">
                  <lucide-icon [img]="File" [size]="20" class="text-violet-400"></lucide-icon>
                </div>
              }
              <div class="flex flex-col min-w-0 mr-2">
                <span class="text-xs font-medium text-white/90 truncate max-w-[200px]">{{ fileEntry.file.name }}</span>
                <span class="text-[10px] text-white/40">{{ formatFileSize(fileEntry.file.size) }}</span>
              </div>
              
              @if (fileEntry.uploading) {
                <lucide-icon [img]="Loader2" [size]="16" class="text-violet-400 animate-spin mx-1"></lucide-icon>
              } @else if (fileEntry.error) {
                <lucide-icon [img]="X" [size]="16" class="text-red-400 mx-1"></lucide-icon>
              } @else {
                <button (click)="removeSelectedFile($index)" class="size-6 rounded-full hover:bg-white/10 flex items-center justify-center text-white/40 hover:text-red-400 transition-colors">
                  <lucide-icon [img]="X" [size]="14"></lucide-icon>
                </button>
              }
            </div>
            }
          </div>
          }

          @if (linkPreviewLoading) {
            <div class="flex items-center gap-2 px-1 py-2 text-white/40 animate-pulse">
              <lucide-icon [img]="Loader2" [size]="16" class="animate-spin"></lucide-icon>
              <span class="text-xs">Загрузка предпросмотра...</span>
            </div>
          } @else if (linkPreview) {
            <div class="relative w-full max-w-[400px] mb-2 group/preview">
              <app-link-preview [preview]="linkPreview" [showMedia]="false"></app-link-preview>
              <button
                (click)="linkPreview = null; isLinkPreviewDismissed = true"
                class="absolute -top-2 -right-2 bg-black/60 hover:bg-black/80 text-white/70 hover:text-white rounded-full p-1 transition-all opacity-0 group-hover/preview:opacity-100"
                title="Удалить предпросмотр"
              >
                <lucide-icon [img]="X" [size]="14"></lucide-icon>
              </button>
            </div>
          }

          <div
            class="relative flex items-center bg-white/3 border border-transparent rounded-[18px] h-[52px] transition-colors focus-within:border-white/10 focus-within:bg-white/5 group">
            <div class="flex items-center gap-2 mx-2">
              <button (click)="triggerFileInput()" 
              class="text-white/40 hover:text-white hover:bg-white/5 p-2 rounded-xl transition-all shrink-0"
              [class.opacity-50]="selectedFiles.length >= 50"
              [disabled]="selectedFiles.length >= 50"
              title="Прикрепить файлы (макс. 50)">
              <lucide-icon [img]="Paperclip" [size]="20"></lucide-icon>
            </button>
            </div>

            <div class="flex-1 min-w-0 relative">
              <app-chat-input
                [ngModel]="chatInput"
                (ngModelChange)="chatInput = $event; onChatInputChanged($event)"
                (submit)="sendMessage()"
                placeholder="Сообщение..."
                #chatInputRef>
              </app-chat-input>
            </div>

            @if (chatInput.trim() || (selectedFiles.length > 0 && !isUploadingFile)) {
            <button (click)="sendMessage()"
              class="text-white/90 hover:text-white transition-colors p-2 rounded-full hover:bg-white/9 bg-white/5 animate-scale-in shrink-0 mr-2"
              title="Отправить">
              <lucide-icon [img]="ArrowUp" [size]="17"></lucide-icon>
            </button>
            }
          </div>
        </div>
      </div>
    </div>
  </main>

  <aside class="rounded-[28px] backdrop-blur-3xl bg-[#0D0D10] px-[23px] py-[24px] flex flex-col gap-[28px] z-2">
    <div class="flex items-center gap-[13px] font-bold">
      <h2 class="text-[24px] text-white/70">Демонстрируют экран</h2>
      @if (screenSharingCount > 0) {
      <span class="text-[20px] text-white/35">{{ screenSharingCount }}</span>
      }
    </div>

    @if (screenSharingCount > 0) {
    <div class="flex flex-col gap-[26px] items-start overflow-y-auto">
      <!-- Локальная демонстрация экрана -->
      @if (isScreenSharing) {
      <div class="flex flex-col gap-[14px] items-start" aria-label="Нажмите, чтобы посмотреть демонстрацию экрана" role="button" tabindex="0"
        (click)="openScreenPreview(localScreenStream, currentUser?.username || 'Вы', 'local')">
        <div
          class="aspect-video group cursor-pointer w-full h-auto rounded-[14px] overflow-hidden bg-white/10 border-2 border-emerald-600/50 relative">
          <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity ease-out duration-200 pointer-events-none"></div>
          <video #localScreenVideo class="size-full object-cover" autoplay playsinline muted></video>
          <div
            class="absolute top-2 right-2 bg-emerald-600/90 backdrop-blur-sm px-2 py-1 rounded text-[10px] font-bold text-white uppercase">
            Вы
          </div>
        </div>
        <p class="text-[15px] font-normal text-white/50">{{ currentUser?.username || 'Вы' }}</p>
      </div>
      }

      <!-- Удаленные демонстрации экрана -->
      @for (peer of remotePeers; track peer.socketId) {
      @if (peer.isScreenSharing) {
      <div class="flex flex-col gap-[14px] items-start" aria-label="Нажмите, чтобы посмотреть демонстрацию экрана" role="button" tabindex="0"
        (click)="openScreenPreview(peer.screenStream, peer.username, peer.socketId)">
        <div
          class="aspect-video cursor-pointer w-[243px] h-auto rounded-[12px] overflow-hidden bg-white/10 border-2 border-violet-600/50 relative">
          <video #remoteScreen [attr.data-peer-id]="peer.socketId" class="size-full object-cover backdrop-blur-sm" autoplay playsinline
            muted></video>
          <div
            class="absolute top-2 right-2 bg-red-600/90 backdrop-blur-sm px-2 py-1 rounded text-[10px] font-bold text-white uppercase animate-pulse">
            LIVE
          </div>
        </div>
        <p class="text-[15px] font-normal text-white/50">{{ peer.username }}</p>
      </div>
      }
      }
    </div>
    } @else {
    <!-- Пустое состояние -->
    <div class="flex-1 flex items-center justify-center">
      <div class="text-center max-w-[200px]">
        <div class="w-16 h-16 mx-auto mb-4 bg-white/5 rounded-xl flex items-center justify-center">
          <lucide-icon [img]="Monitor" [size]="32" class="text-white/30"></lucide-icon>
        </div>
        <p class="text-sm text-white/40">Никто не демонстрирует экран</p>
      </div>
    </div>
    }
  </aside>

  <!-- Hidden Audio Elements -->
  <div class="hidden">
    @for (peer of remotePeers; track peer.socketId) {
    <audio #remoteAudio [attr.data-peer-id]="peer.socketId" autoplay></audio>
    }
  </div>
</div>

<!-- Screen Preview Modal -->
<app-modal
  [isOpen]="showScreenPreviewModal"
  [customLayout]="true"
  [backdropClass]="'bg-black/80'"
  customWidth="75vw"
  (closed)="closeScreenPreview()"
>
  <div slot="custom">
    <div class="w-full h-full flex flex-col items-center justify-center gap-6 px-4 py-6">
      <div class="w-full aspect-video rounded-[18px] overflow-hidden bg-black relative group" 
           [class.!rounded-none]="previewIsFullscreen" 
           [class.!aspect-auto]="previewIsFullscreen" 
           [class.!h-screen]="previewIsFullscreen" 
           [class.!w-screen]="previewIsFullscreen">
        <video #previewVideo class="size-full object-contain" autoplay playsinline muted></video>
        
        <!-- Оверлей с контролами (показывается при наведении) -->
        <div class="absolute bg-linear-to-t from-black/60 via-transparent to-transparent opacity-0 transition-opacity duration-200"
             [ngClass]="{
               'inset-x-0 bottom-0 top-auto h-32 pointer-events-auto hover:opacity-100': previewIsFullscreen,
               'inset-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto': !previewIsFullscreen
             }">
          <!-- Контролы справа снизу -->
          <div class="absolute bottom-4 right-4 flex items-center gap-2">
            <!-- Контролы аудио (если есть) -->
            @if (previewHasAudio) {
            <div class="flex items-center gap-2 bg-black/60 backdrop-blur-md rounded-full px-3 py-2 border border-white/10">
              <!-- Кнопка включения/выключения звука -->
              <button
                type="button"
                (click)="togglePreviewAudio()"
                class="size-8 flex items-center justify-center text-white/70 hover:text-white transition-colors"
                [appTooltip]="previewAudioEnabled ? 'Выключить звук' : 'Включить звук'"
                tooltipPosition="top"
              >
                @if (previewAudioEnabled) {
                <lucide-icon [img]="Volume2" [size]="18"></lucide-icon>
                } @else {
                <lucide-icon [img]="VolumeX" [size]="18"></lucide-icon>
                }
              </button>
              
              <!-- Слайдер громкости -->
              @if (previewAudioEnabled) {
              <input
                type="range"
                min="0"
                max="1"
                step="0.01"
                [value]="previewAudioVolume"
                (input)="onPreviewAudioVolumeChange($event)"
                class="w-20 h-1 bg-white/20 rounded-full appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:size-3 [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer"
              />
              }
            </div>
            }
            
            <!-- Кнопка полноэкранного режима -->
            <button
              type="button"
              (click)="togglePreviewFullscreen()"
              class="size-10 flex items-center justify-center bg-black/60 backdrop-blur-md text-white/70 hover:text-white rounded-full border border-white/10 transition-colors"
              [appTooltip]="previewIsFullscreen ? 'Выйти из полноэкранного режима' : 'Полноэкранный режим'"
              tooltipPosition="top"
            >
              @if (previewIsFullscreen) {
              <lucide-icon [img]="X" [size]="20"></lucide-icon>
              } @else {
              <lucide-icon [img]="Maximize" [size]="20"></lucide-icon>
              }
            </button>
          </div>
        </div>
      </div>
      
      <button type="button"
        class="size-12 rounded-full bg-white/10 text-white/70 flex items-center justify-center hover:bg-white/20 transition-all active:scale-90 shrink-0"
        (click)="closeScreenPreview()" [appTooltip]="'Закрыть просмотр'" tooltipPosition="top">
        <lucide-icon [img]="X" [size]="20" class="text-white"></lucide-icon>
      </button>
    </div>
  </div>
</app-modal>

<router-outlet></router-outlet>
}

<!-- Media Viewer Modal -->
<app-media-viewer-modal
  [isOpen]="showMediaViewer"
  [initialItem]="selectedMediaItem"
  [galleryItems]="mediaGalleryItems"
  (closed)="closeMediaViewer()"
></app-media-viewer-modal>