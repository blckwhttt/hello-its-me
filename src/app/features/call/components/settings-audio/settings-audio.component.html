<div class="space-y-11 animate-fade-in pb-4">
  <!-- Devices Selection -->
  <section class="space-y-6">
    <div class="space-y-3">
      <p class="text-xs font-medium text-white/40 uppercase tracking-wide">Аудио устройства</p>
      <h3 class="text-2xl font-semibold text-white/90">Устройства ввода и вывода</h3>
      <p class="text-sm text-white/60 leading-relaxed max-w-3xl">
        Выберите устройства для записи и воспроизведения звука. Убедитесь, что выбраны правильные микрофон и динамики для качественной связи.
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
      <!-- Input Device -->
      <div class="flex flex-col gap-3.5 bg-black/20 rounded-[18px] p-5 border border-white/5">
        <label class="text-xs font-medium text-white/50 uppercase tracking-wide">Устройство ввода (Микрофон)</label>
        <app-custom-select
          [options]="audioInputOptions"
          [(value)]="selectedInputId"
          (valueChange)="onInputDeviceChange($event)"
          [icon]="Mic"
          class="w-full block relative z-20"
        >
        </app-custom-select>
      </div>

      <!-- Output Device -->
      <div class="flex flex-col gap-3.5 bg-black/20 rounded-[18px] p-5 border border-white/5">
        <label class="text-xs font-medium text-white/50 uppercase tracking-wide">Устройство вывода (Динамики)</label>
        <app-custom-select
          [options]="audioOutputOptions"
          [(value)]="selectedOutputId"
          (valueChange)="onOutputDeviceChange($event)"
          [icon]="RadioIcon"
          class="w-full block relative z-10"
        >
        </app-custom-select>
      </div>
    </div>
  </section>

  <!-- Audio Processing Section -->
  <section class="space-y-6">
    <div class="space-y-3">
      <p class="text-xs font-medium text-white/40 uppercase tracking-wide">Улучшение качества</p>
      <h3 class="text-2xl font-semibold text-white/90">Обработка звука</h3>
      <p class="text-sm text-white/60 leading-relaxed max-w-3xl">
        Технологии подавления помогают улучшить качество звука, фильтруя нежелательные шумы и эхо в реальном времени.
      </p>
    </div>

    <div class="space-y-2">
      <!-- Noise Suppression -->
      <div class="bg-black/20 rounded-[20px] border border-white/5 p-6 hover:bg-black/30 transition-all duration-200 group">
        <div class="flex items-start gap-5">
          <!-- Icon -->
          <div
            class="size-11 rounded-[14px] bg-violet-500/10 flex items-center justify-center text-violet-400 shrink-0 group-hover:scale-105 group-hover:bg-violet-500/15 transition-all duration-300"
          >
            <lucide-icon [img]="Mic" [size]="22"></lucide-icon>
          </div>

          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2.5">
                <h4 class="text-lg font-semibold text-white/90">Шумоподавление</h4>
                @if (settings.noiseSuppression) {
                <span
                  class="px-2.5 py-1 rounded-full text-[10px] tracking-wide font-medium bg-violet-500/15 text-violet-300 border border-violet-400/20 uppercase"
                  >Активно</span
                >
                }
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  [(ngModel)]="settings.noiseSuppression"
                  (change)="updateSettings()"
                  class="sr-only peer"
                />
                <div
                  class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-500 hover:opacity-90 peer-checked:hover:opacity-100 transition-opacity"
                ></div>
              </label>
            </div>
            <p class="text-sm text-white/50 leading-relaxed mb-3.5">
              Автоматически фильтрует фоновые шумы, такие как стук клавиш, работа вентилятора или шум
              улицы, делая ваш голос чище и разборчивее для собеседников.
            </p>
            <div class="flex items-center gap-1.5 text-xs text-white/40 hover:text-white/60 transition-colors cursor-help"
              [appTooltip]="'Использует алгоритмы WebRTC для анализа и удаления стационарных шумов в режиме реального времени'"
              tooltipPosition="bottom"
            >
              <lucide-icon [img]="Info" [size]="14"></lucide-icon>
              <span>Как это работает?</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Echo Cancellation -->
      <div class="bg-black/20 rounded-[20px] border border-white/5 p-6 hover:bg-black/30 transition-all duration-200 group">
        <div class="flex items-start gap-5">
          <!-- Icon -->
          <div
            class="size-11 rounded-[14px] bg-blue-500/10 flex items-center justify-center text-blue-400 shrink-0 group-hover:scale-105 group-hover:bg-blue-500/15 transition-all duration-300"
          >
            <lucide-icon [img]="Radio" [size]="22"></lucide-icon>
          </div>

          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2.5">
                <h4 class="text-lg font-semibold text-white/90">Эхоподавление</h4>
                @if (settings.echoCancellation) {
                <span
                  class="px-2.5 py-1 rounded-full text-[10px] tracking-wide font-medium bg-violet-500/15 text-violet-300 border border-violet-400/20 uppercase"
                  >Активно</span
                >
                }
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  [(ngModel)]="settings.echoCancellation"
                  (change)="updateSettings()"
                  class="sr-only peer"
                />
                <div
                  class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-500 hover:opacity-90 peer-checked:hover:opacity-100 transition-opacity"
                ></div>
              </label>
            </div>
            <p class="text-sm text-white/50 leading-relaxed mb-3.5">
              Предотвращает попадание звука из ваших динамиков обратно в микрофон, устраняя неприятное
              эхо для собеседников. Особенно полезно при использовании колонок.
            </p>
            <div class="flex items-center gap-1.5 text-xs text-white/40 hover:text-white/60 transition-colors cursor-help"
              [appTooltip]="'Критически важно при использовании колонок вместо наушников для предотвращения эффекта обратной связи'"
              tooltipPosition="bottom"
            >
              <lucide-icon [img]="Info" [size]="14"></lucide-icon>
              <span>Рекомендация</span>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div class="bg-violet-500/8 border border-violet-400/15 rounded-[18px] p-5 flex gap-4 items-start">
      <div class="text-violet-400 shrink-0 mt-0.5">
        <lucide-icon [img]="Info" [size]="20"></lucide-icon>
      </div>
      <div class="space-y-1">
        <p class="text-sm font-medium text-violet-200">Полезная информация</p>
        <p class="text-sm text-violet-200/70 leading-relaxed">
          Изменения настроек применяются мгновенно. Если вы испытываете проблемы со звуком, попробуйте
          отключить шумоподавление, так как в некоторых случаях оно может "съедать" окончания слов.
        </p>
      </div>
    </div>
  </section>


  <!-- Communication Mode Showcase -->
  <section
    class="space-y-8"
  >
    <div class="flex flex-wrap items-start justify-between gap-6">
      <div class="space-y-3 max-w-3xl">
        <p class="text-xs font-medium text-white/40 uppercase tracking-wide">Голосовой контроль</p>
        <div class="flex items-center gap-4 flex-wrap">
          <h3 class="text-2xl font-semibold text-white/90">Режим общения</h3>
          @if (pushToTalkControlsEnabled) {
          <span
            class="px-3 py-1.5 rounded-full text-[11px] font-medium bg-violet-500/15 text-violet-200 border border-violet-400/30 uppercase tracking-wide"
            >Режим рации активен</span
          >
          } @else if (!isElectronApp) {
          <span
            class="px-3 py-1.5 rounded-full text-[11px] font-medium bg-white/5 text-white/70 border border-white/15 uppercase tracking-wide"
            >Временно недоступно в браузерах</span
          >
          } @else {
          <span
            class="px-3 py-1.5 rounded-full text-[11px] font-medium bg-white/5 text-white/70 border border-white/15 uppercase tracking-wide"
            >Автоматический</span
          >
          }
        </div>
        <p class="text-sm text-white/60 leading-relaxed">
          Сохраняйте привычный авто-режим или включайте формат рации с удержанием клавиш, чтобы
          исключить случайные шумы и держать голос под полным контролем.
        </p>
      </div>
      <button
        type="button"
        class="flex items-center gap-2 text-sm text-white/70 hover:text-white/90 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 rounded-[16px] px-4 py-2.5 transition-all duration-200"
        [appTooltip]="modeDescription"
        tooltipPosition="bottom"
      >
        <lucide-icon [img]="Info" [size]="16"></lucide-icon>
        <span>Как работает</span>
      </button>
    </div>

    <div class="flex flex-wrap items-center gap-3">
      <button
        type="button"
        class="px-5 py-3 rounded-[18px] border text-base font-semibold transition-all duration-200"
        [class]="communicationSettings.mode === 'auto' 
          ? 'border-violet-400/50 bg-violet-500/20 text-white' 
          : 'border-white/15 text-white/70 hover:border-white/25 hover:bg-white/5'"
        (click)="selectCommunicationMode('auto')"
      >
        Автоматический
      </button>
      <button
        type="button"
        class="px-5 py-3 rounded-[18px] border text-base font-semibold transition-all duration-200 flex items-center gap-2"
        [class]="communicationSettings.mode === 'push-to-talk' 
          ? 'border-violet-400/50 bg-violet-500/20 text-white' 
          : 'border-white/15 text-white/70 hover:border-white/25 hover:bg-white/5 ' + (!isElectronApp ? 'opacity-40' : '')"
        [attr.aria-disabled]="!isElectronApp"
        [disabled]="!isElectronApp"
        (click)="selectCommunicationMode('push-to-talk')"
      >
        <lucide-icon [img]="Zap" [size]="18"></lucide-icon>
        Режим рации
      </button>
    </div>

    @if (pushToTalkControlsEnabled) {
    <div class="grid gap-5 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
      <div class="rounded-[20px] bg-black/20 border border-white/5 p-6 space-y-5">
        <div class="flex flex-col gap-2.5">
            <div class="flex items-center justify-between gap-4">
              <p class="text-lg font-semibold text-white/90">Сочетание клавиш</p>
            <button
            type="button"
            class="text-xs font-semibold text-white/50 hover:text-white/90 transition-colors disabled:opacity-40"
            (click)="resetShortcutToDefault()"
            [disabled]="!pushToTalkControlsEnabled"
          >
            Сбросить
          </button>
            </div>
            <p class="text-sm text-white/50 leading-relaxed">
              Удерживайте комбинацию клавиш, чтобы мгновенно активировать микрофон в режиме рации.
            </p>
        </div>

        <button
          type="button"
          class="w-full rounded-[16px] border border-violet-400/20 bg-violet-400/10 px-5 py-4 flex items-center justify-between text-left font-semibold transition-all hover:bg-violet-400/15 hover:border-violet-400/30"
          (click)="isCapturingShortcut ? cancelShortcutCapture() : beginShortcutCapture()"
          [attr.aria-pressed]="isCapturingShortcut"
        >
          <span
            class="text-white text-base"
            [class.text-violet-200]="isCapturingShortcut"
          >
            {{ isCapturingShortcut ? 'Нажмите нужную комбинацию…' : shortcutDisplay }}
          </span>
          <span class="text-xs text-white/50 flex items-center gap-1.5">
            <lucide-icon [img]="Info" [size]="14"></lucide-icon>
            <span>{{ isCapturingShortcut ? 'Esc — отменить' : 'Изменить' }}</span>
          </span>
        </button>

        @if (shortcutError) {
        <p class="text-sm text-rose-300 leading-relaxed">{{ shortcutError }}</p>
        } @else {
        <p class="text-sm text-white/40 leading-relaxed">
          Добавьте минимум один модификатор (Ctrl / Alt / Shift / Cmd), чтобы исключить случайные
          срабатывания при наборе текста в чате или других приложениях.
        </p>
        }
      </div>

      <div class="rounded-[20px] bg-black/20 border border-white/5 p-6 space-y-5">
        <div class="flex items-start justify-between gap-4">
          <div class="flex flex-col gap-2.5">
            <p class="text-lg font-semibold text-white/90">Задержка отключения</p>
          <p class="text-sm text-white/50 leading-relaxed">
            Плавное затухание после отпускания клавиш, чтобы не обрезать окончания фраз и слов.
          </p>
          </div>
        </div>

        <div class="flex flex-col">
          <div class="mb-3.5">
            <span class="text-[15px] font-semibold text-white/90 rounded-full bg-white/5 px-2 py-1.5">
              {{ communicationSettings.releaseDelayMs }} мс
            </span>
          </div>
          <div class="flex flex-col gap-2">
            <!-- Custom Range Slider -->
            <div 
              class="relative w-full h-6 flex items-center cursor-pointer group"
              [class.opacity-40]="!pushToTalkControlsEnabled"
              [class.pointer-events-none]="!pushToTalkControlsEnabled"
              (mousedown)="onSliderMouseDown($event)"
              (touchstart)="onSliderTouchStart($event)"
            >
              <!-- Track -->
              <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-1.5 bg-white/10 rounded-full overflow-hidden">
                <!-- Progress -->
                <div 
                  class="absolute inset-y-0 left-0 bg-linear-to-r from-violet-500 to-violet-400 rounded-full transition-all duration-75"
                  [style.width.%]="sliderProgressPercent"
                ></div>
              </div>
              
              <!-- Thumb -->
              <div 
                class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 size-5 rounded-full bg-violet-400 border-[3px] border-[#1a1a1a] transition-all duration-200 z-10"
                [ngClass]="{
                  'scale-110': isSliderDragging,
                  'group-hover:scale-110': !isSliderDragging && pushToTalkControlsEnabled,
                  'shadow-lg': !isSliderDragging && !isSliderHovered,
                  'shadow-[0_2px_12px_rgba(139,92,246,0.6)]': isSliderDragging || isSliderHovered
                }"
                [style.left.%]="sliderProgressPercent"
                [style.box-shadow]="(isSliderDragging || (isSliderHovered && pushToTalkControlsEnabled)) ? '0 2px 12px rgba(139, 92, 246, 0.6), 0 0 0 4px rgba(139, 92, 246, 0.2)' : null"
                (mouseenter)="isSliderHovered = true"
                (mouseleave)="isSliderHovered = false"
              ></div>
            </div>
          <div class="flex items-center justify-between text-xs text-white/55">
            <span>0 мс</span>
            <span>1000 мс</span>
          </div>
          </div>
        </div>

        <p class="text-sm text-white/40 leading-relaxed">
          Значение по умолчанию — 200 мс. При необходимости вы можете адаптировать параметр под свой
          темп общения и манеру разговора.
        </p>
      </div>
    </div>
    }
  </section>
</div>
